# http://www.python36.com/predict-cryptocurrency-price-using-lstm/

# execfile('./initCryptosJer.py')
# exec(open('./initCryptosJer.py').read())
# exec(open('tensorflow-master/predict crypto/scriptsJer/initCryptosJer.py').read())

# LSTM for closing bitcoin price with regression framing
import numpy as np
import matplotlib.pyplot as plt
import pandas as pd
from pandas import read_json
from keras.models import Sequential, load_model
from keras.layers import Dense
from keras.layers import LSTM
from sklearn.preprocessing import MinMaxScaler
from sklearn.metrics import mean_squared_error
from sklearn.model_selection import train_test_split
import math
import os

os.environ['TF_CPP_MIN_LOG_LEVEL'] = '3'



# convert an array of values into a dataset matrix
def create_dataset(dataset):
  dataX, dataY = [], []
  for i in range(len(dataset)-1):
    dataX.append(dataset[i])
    dataY.append(dataset[i + 1])
  return np.asarray(dataX), np.asarray(dataY)

# view-source:https://api.bitfinex.com/v2/candles/trade:1h:tBTCUSD/hist
#j_son = '[[1529064000000,6529.5,6517.7,6529.5,6511,61.86246443],[1529060400000,6585.6,6530.07791658,6659,6450,2182.26847355],[1529056800000,6588.2,6585.6,6597,6555.2,792.44072145],[1529053200000,6589.5,6588.2,6597.4,6554.7,735.42007243],[1529049600000,6572.6,6589.5,6614.48347786,6550.2,690.83525503],[1529046000000,6580.7,6572.6,6598.1,6566.5,446.21856233],[1529042400000,6574.2,6580.6,6615,6559.5,515.91477636],[1529038800000,6559.9,6574.2,6584.1,6550.2,426.49981021],[1529035200000,6598,6559.9,6598.1,6550.3,807.70430334],[1529031600000,6589.9,6598,6618.5,6584.7,384.91763318],[1529028000000,6588.2,6589.8,6590.6,6555,565.20362266],[1529024400000,6613.6,6588.3,6614.3,6560,710.6721469],[1529020800000,6633.8,6614.3,6642.1,6582.4,456.26056032],[1529017200000,6614.8,6633.7,6709.14278109,6580,2110.50795586],[1529013600000,6639.7,6614.8,6650.7,6584.8,448.93015754],[1529010000000,6650.3,6639.7,6687.9,6631.7,417.45063871],[1529006400000,6637,6650.3,6681.9,6623,754.50142545],[1529002800000,6650,6637,6654.4,6602.2,701.29324579],[1528999200000,6611.2,6650,6736.52103872,6609.6,2432.84862598],[1528995600000,6521.1,6611.2,6649,6496.7,3743.37840946],[1528992000000,6349.9,6521.1,6555.2,6349.9,2681.28478591],[1528988400000,6419,6350,6419,6322,1504.25800521],[1528984800000,6371.8,6419,6436,6371.8,1037.31267267],[1528981200000,6486,6371.7,6486.1,6361.2,2533.38459461],[1528977600000,6523.3,6486,6523.3,6468.8,627.35628621],[1528974000000,6484.7,6523.3,6538,6484.5,1217.86509615],[1528970400000,6494.5,6484.7,6500,6470,326.88806789],[1528966800000,6484.2,6495.3,6503.2,6475.4,352.53178459],[1528963200000,6477.7,6484.1,6599.8,6450.2,3683.63855631],[1528959600000,6479.3,6477.2,6480,6442.1,696.94102898],[1528956000000,6470.1,6476.2,6489.9,6462.1,421.14527544],[1528952400000,6469.3,6470.1,6490,6435.7,874.64626562],[1528948800000,6487.9,6469.2,6506.2,6469.2,502.83331513],[1528945200000,6471.2,6487.9,6498,6458.4,715.36889209],[1528941600000,6313.2,6469.5,6548,6313.2,3541.67158654],[1528938000000,6273.2,6313.2,6338.1,6269.6,995.48771196],[1528934400000,6295,6273.2,6332.9,6269.5,743.25797974],[1528930800000,6325.1,6295.1,6344.3,6275.4,669.91689248],[1528927200000,6275.9,6322.6,6349.5,6270,1395.3914626],[1528923600000,6259.6,6278,6287.4,6214.26482243,1060.22473998],[1528920000000,6284.2,6259.5,6290.9,6225,1302.83733024],[1528916400000,6321.8,6284.5,6347.1,6250,2022.36695292],[1528912800000,6318,6321.9,6368.8,6308,1705.6584703],[1528909200000,6277,6313,6328,6226.7,2248.55812265],[1528905600000,6375,6277,6408.2,6107.87718467,15872.56611285],[1528902000000,6429.9,6375.1,6460,6337,2073.72912628],[1528898400000,6454.5,6429.9,6454.6,6405.1,987.11343953],[1528894800000,6456.4,6454.6,6484.8,6439.03197718,568.10114705],[1528891200000,6447.3,6456.3,6491.2,6416.1,2516.34715428],[1528887600000,6432.5,6447.36873047,6464.4174852,6415,1289.09355609],[1528884000000,6400.4,6431.7,6478.4,6400.4,1490.93153345],[1528880400000,6522.7,6400.4,6536.2,6370,4227.35016506],[1528876800000,6544.1,6522.7,6562.6,6500,1267.64163532],[1528873200000,6569.9,6544,6578.6,6533.7,625.48373156],[1528869600000,6570.1,6570,6578.5,6563.1,513.27094693],[1528866000000,6585,6570.2,6611.7,6552.7,1206.91595891],[1528862400000,6550.1,6584.9,6588.5,6517.4515652,846.06869642],[1528858800000,6554.3,6550.1,6554.5,6530.1,461.00409316],[1528855200000,6543.5,6554.4,6570,6543.5,239.04645567],[1528851600000,6544,6542.7,6557.7,6536.91114358,268.65697429],[1528848000000,6543.9,6543.9,6570.2,6535,719.30716368],[1528844400000,6528.5,6543.9,6572.3,6480,2503.39231933],[1528840800000,6531.7,6528.5,6559.7,6520.1,567.69931241],[1528837200000,6525,6531.8,6550,6484.24990102,1689.09484357],[1528833600000,6498.6,6522.33675361,6577,6484.1,2336.04983864],[1528830000000,6684.1,6498.5,6684.2,6436.1,8669.31986288],[1528826400000,6720.4,6684.2,6724.8,6661.2,1708.4099897],[1528822800000,6729.1,6720.4,6746.3,6710,626.7150602],[1528819200000,6752.81847795,6729.1,6760,6667,1717.72605827],[1528815600000,6752.1,6752.8,6754.9,6735.3,231.14287513],[1528812000000,6732.8,6752,6778.7,6711.1,709.35664745],[1528808400000,6722.4,6732.8,6743.8,6698.2,1914.33371294],[1528804800000,6827.1,6722.4,6834.3,6683.17561393,1470.72601992],[1528801200000,6836.4,6827.2,6845.1,6801.6,661.7806736],[1528797600000,6842.1,6836.4,6844,6823.5,335.63243113],[1528794000000,6845.72384404,6842.1,6850,6840.3,404.00925049],[1528790400000,6826,6846.5,6868.6,6796.5,1299.72705633],[1528786800000,6832.1,6825.8,6852.3,6812,762.18897425],[1528783200000,6831.7,6832,6835,6827.1,274.01183261],[1528779600000,6815.8,6831.7,6840.1,6814,250.72501436],[1528776000000,6811.5,6815.7,6846,6804.7,483.28602098],[1528772400000,6856.2,6811.4,6859.1,6784.1,1118.47284824],[1528768800000,6847.00019453,6856.3,6865.4,6833.1,727.48371474],[1528765200000,6842.9,6847,6849.7,6825,782.20386884],[1528761600000,6873.4,6842.8,6873.4,6826.7,764.82457688],[1528758000000,6783.2,6873.3,6899,6775,1965.62743549],[1528754400000,6767.1,6783.2,6790.9,6745,387.67876765],[1528750800000,6753.4,6767.1,6770.2,6748.8,279.14978707],[1528747200000,6756,6753.4,6761,6723.2,612.58942491],[1528743600000,6744.7,6756,6800.3,6732.1,1595.81937658],[1528740000000,6713.6,6744.7,6774.7,6675,1438.7834865],[1528736400000,6728.1,6713.5,6741.46838356,6713,305.82336835],[1528732800000,6692.7,6728,6746.9,6692.2,1087.73351083],[1528729200000,6707.3,6692.7,6720.9,6636.7,1664.57164657],[1528725600000,6743.84491283,6707.3,6751,6671.2,1361.32705163],[1528722000000,6761.5,6743.9,6766.3,6741.3,518.89143627],[1528718400000,6778.3,6764.1,6786.6,6724,913.05068841],[1528714800000,6759,6778.2,6780,6740.4,504.35893861],[1528711200000,6762.1,6758.9,6768.5,6723,598.40296267],[1528707600000,6782.3,6762,6803,6754.8,512.20309043],[1528704000000,6632.6,6783,6821.1,6629.7,1992.11147005],[1528700400000,6734.8,6632.6,6750.4,6631,1145.4294513],[1528696800000,6734,6734.8,6757.2,6713.7,339.81142513],[1528693200000,6772.1,6734.1,6778.27308962,6719.3,595.11289378],[1528689600000,6763.3,6772.1,6789.4,6737.8,495.97836909],[1528686000000,6772,6763.2,6784.6,6736.8,629.01186764],[1528682400000,6752.4,6772.1,6807.3,6741.7,1173.15977461],[1528678800000,6714.5,6752.2,6752.7,6689.4,1403.92340544],[1528675200000,6757.9,6714.4,6758,6705.3,857.19166417],[1528671600000,6669.8,6758,6768.4,6665.9,1668.23608412],[1528668000000,6723.48544081,6669.8,6742.1,6655,2298.94854782],[1528664400000,6702.7,6723.5,6763.7,6675,2434.89302184],[1528660800000,6825.5,6702.7,6826.6,6618.9,5341.79039043],[1528657200000,6739.5,6825.5,6844.9,6703,4184.84510866],[1528653600000,6734.8,6739.5,6786.1,6630,6336.56089484],[1528650000000,7191.82113079,6738.1,7202.3,6700,14050.68250078],[1528646400000,7226.89629522,7191.8,7236.7,7187.4,659.24157771],[1528642800000,7228.4,7226.89629522,7248,7209.8,323.6828298],[1528639200000,7267.9,7228.4,7268,7227.7,233.19154743],[1528635600000,7228.8,7267.8,7278.9,7175,988.67529939]]'
j_son = '[[1529067600000,6502.8,6508.2,6523.8,6476.3,442.92832849],[1529064000000,6529.5,6502.72088387,6530,6478.1,1114.51734746],[1529060400000,6585.6,6530.07791658,6659,6450,2182.26847355],[1529056800000,6588.2,6585.6,6597,6555.2,792.44072145],[1529053200000,6589.5,6588.2,6597.4,6554.7,735.42007243],[1529049600000,6572.6,6589.5,6614.48347786,6550.2,690.83525503],[1529046000000,6580.7,6572.6,6598.1,6566.5,446.21856233],[1529042400000,6574.2,6580.6,6615,6559.5,515.91477636],[1529038800000,6559.9,6574.2,6584.1,6550.2,426.49981021],[1529035200000,6598,6559.9,6598.1,6550.3,807.70430334],[1529031600000,6589.9,6598,6618.5,6584.7,384.91763318],[1529028000000,6588.2,6589.8,6590.6,6555,565.20362266],[1529024400000,6613.6,6588.3,6614.3,6560,710.6721469],[1529020800000,6633.8,6614.3,6642.1,6582.4,456.26056032],[1529017200000,6614.8,6633.7,6709.14278109,6580,2110.50795586],[1529013600000,6639.7,6614.8,6650.7,6584.8,448.93015754],[1529010000000,6650.3,6639.7,6687.9,6631.7,417.45063871],[1529006400000,6637,6650.3,6681.9,6623,754.50142545],[1529002800000,6650,6637,6654.4,6602.2,701.29324579],[1528999200000,6611.2,6650,6736.52103872,6609.6,2432.84862598],[1528995600000,6521.1,6611.2,6649,6496.7,3743.37840946],[1528992000000,6349.9,6521.1,6555.2,6349.9,2681.28478591],[1528988400000,6419,6350,6419,6322,1504.25800521],[1528984800000,6371.8,6419,6436,6371.8,1037.31267267],[1528981200000,6486,6371.7,6486.1,6361.2,2533.38459461],[1528977600000,6523.3,6486,6523.3,6468.8,627.35628621],[1528974000000,6484.7,6523.3,6538,6484.5,1217.86509615],[1528970400000,6494.5,6484.7,6500,6470,326.88806789],[1528966800000,6484.2,6495.3,6503.2,6475.4,352.53178459],[1528963200000,6477.7,6484.1,6599.8,6450.2,3683.63855631],[1528959600000,6479.3,6477.2,6480,6442.1,696.94102898],[1528956000000,6470.1,6476.2,6489.9,6462.1,421.14527544],[1528952400000,6469.3,6470.1,6490,6435.7,874.64626562],[1528948800000,6487.9,6469.2,6506.2,6469.2,502.83331513],[1528945200000,6471.2,6487.9,6498,6458.4,715.36889209],[1528941600000,6313.2,6469.5,6548,6313.2,3541.67158654],[1528938000000,6273.2,6313.2,6338.1,6269.6,995.48771196],[1528934400000,6295,6273.2,6332.9,6269.5,743.25797974],[1528930800000,6325.1,6295.1,6344.3,6275.4,669.91689248],[1528927200000,6275.9,6322.6,6349.5,6270,1395.3914626],[1528923600000,6259.6,6278,6287.4,6214.26482243,1060.22473998],[1528920000000,6284.2,6259.5,6290.9,6225,1302.83733024],[1528916400000,6321.8,6284.5,6347.1,6250,2022.36695292],[1528912800000,6318,6321.9,6368.8,6308,1705.6584703],[1528909200000,6277,6313,6328,6226.7,2248.55812265],[1528905600000,6375,6277,6408.2,6107.87718467,15872.56611285],[1528902000000,6429.9,6375.1,6460,6337,2073.72912628],[1528898400000,6454.5,6429.9,6454.6,6405.1,987.11343953],[1528894800000,6456.4,6454.6,6484.8,6439.03197718,568.10114705],[1528891200000,6447.3,6456.3,6491.2,6416.1,2516.34715428],[1528887600000,6432.5,6447.36873047,6464.4174852,6415,1289.09355609],[1528884000000,6400.4,6431.7,6478.4,6400.4,1490.93153345],[1528880400000,6522.7,6400.4,6536.2,6370,4227.35016506],[1528876800000,6544.1,6522.7,6562.6,6500,1267.64163532],[1528873200000,6569.9,6544,6578.6,6533.7,625.48373156],[1528869600000,6570.1,6570,6578.5,6563.1,513.27094693],[1528866000000,6585,6570.2,6611.7,6552.7,1206.91595891],[1528862400000,6550.1,6584.9,6588.5,6517.4515652,846.06869642],[1528858800000,6554.3,6550.1,6554.5,6530.1,461.00409316],[1528855200000,6543.5,6554.4,6570,6543.5,239.04645567],[1528851600000,6544,6542.7,6557.7,6536.91114358,268.65697429],[1528848000000,6543.9,6543.9,6570.2,6535,719.30716368],[1528844400000,6528.5,6543.9,6572.3,6480,2503.39231933],[1528840800000,6531.7,6528.5,6559.7,6520.1,567.69931241],[1528837200000,6525,6531.8,6550,6484.24990102,1689.09484357],[1528833600000,6498.6,6522.33675361,6577,6484.1,2336.04983864],[1528830000000,6684.1,6498.5,6684.2,6436.1,8669.31986288],[1528826400000,6720.4,6684.2,6724.8,6661.2,1708.4099897],[1528822800000,6729.1,6720.4,6746.3,6710,626.7150602],[1528819200000,6752.81847795,6729.1,6760,6667,1717.72605827],[1528815600000,6752.1,6752.8,6754.9,6735.3,231.14287513],[1528812000000,6732.8,6752,6778.7,6711.1,709.35664745],[1528808400000,6722.4,6732.8,6743.8,6698.2,1914.33371294],[1528804800000,6827.1,6722.4,6834.3,6683.17561393,1470.72601992],[1528801200000,6836.4,6827.2,6845.1,6801.6,661.7806736],[1528797600000,6842.1,6836.4,6844,6823.5,335.63243113],[1528794000000,6845.72384404,6842.1,6850,6840.3,404.00925049],[1528790400000,6826,6846.5,6868.6,6796.5,1299.72705633],[1528786800000,6832.1,6825.8,6852.3,6812,762.18897425],[1528783200000,6831.7,6832,6835,6827.1,274.01183261],[1528779600000,6815.8,6831.7,6840.1,6814,250.72501436],[1528776000000,6811.5,6815.7,6846,6804.7,483.28602098],[1528772400000,6856.2,6811.4,6859.1,6784.1,1118.47284824],[1528768800000,6847.00019453,6856.3,6865.4,6833.1,727.48371474],[1528765200000,6842.9,6847,6849.7,6825,782.20386884],[1528761600000,6873.4,6842.8,6873.4,6826.7,764.82457688],[1528758000000,6783.2,6873.3,6899,6775,1965.62743549],[1528754400000,6767.1,6783.2,6790.9,6745,387.67876765],[1528750800000,6753.4,6767.1,6770.2,6748.8,279.14978707],[1528747200000,6756,6753.4,6761,6723.2,612.58942491],[1528743600000,6744.7,6756,6800.3,6732.1,1595.81937658],[1528740000000,6713.6,6744.7,6774.7,6675,1438.7834865],[1528736400000,6728.1,6713.5,6741.46838356,6713,305.82336835],[1528732800000,6692.7,6728,6746.9,6692.2,1087.73351083],[1528729200000,6707.3,6692.7,6720.9,6636.7,1664.57164657],[1528725600000,6743.84491283,6707.3,6751,6671.2,1361.32705163],[1528722000000,6761.5,6743.9,6766.3,6741.3,518.89143627],[1528718400000,6778.3,6764.1,6786.6,6724,913.05068841],[1528714800000,6759,6778.2,6780,6740.4,504.35893861],[1528711200000,6762.1,6758.9,6768.5,6723,598.40296267],[1528707600000,6782.3,6762,6803,6754.8,512.20309043],[1528704000000,6632.6,6783,6821.1,6629.7,1992.11147005],[1528700400000,6734.8,6632.6,6750.4,6631,1145.4294513],[1528696800000,6734,6734.8,6757.2,6713.7,339.81142513],[1528693200000,6772.1,6734.1,6778.27308962,6719.3,595.11289378],[1528689600000,6763.3,6772.1,6789.4,6737.8,495.97836909],[1528686000000,6772,6763.2,6784.6,6736.8,629.01186764],[1528682400000,6752.4,6772.1,6807.3,6741.7,1173.15977461],[1528678800000,6714.5,6752.2,6752.7,6689.4,1403.92340544],[1528675200000,6757.9,6714.4,6758,6705.3,857.19166417],[1528671600000,6669.8,6758,6768.4,6665.9,1668.23608412],[1528668000000,6723.48544081,6669.8,6742.1,6655,2298.94854782],[1528664400000,6702.7,6723.5,6763.7,6675,2434.89302184],[1528660800000,6825.5,6702.7,6826.6,6618.9,5341.79039043],[1528657200000,6739.5,6825.5,6844.9,6703,4184.84510866],[1528653600000,6734.8,6739.5,6786.1,6630,6336.56089484],[1528650000000,7191.82113079,6738.1,7202.3,6700,14050.68250078],[1528646400000,7226.89629522,7191.8,7236.7,7187.4,659.24157771],[1528642800000,7228.4,7226.89629522,7248,7209.8,323.6828298],[1528639200000,7267.9,7228.4,7268,7227.7,233.19154743]]'

# load the dataset
df = read_json(j_son)
df = df.iloc[::-1]
date = pd.to_datetime(df[0]*1000000)
close = df[4]

dataset = close.values
dataset = dataset.astype('float32')
dataset = np.reshape(dataset, (-1, 1))


datetime_set = date.values


#print(datetime_set)


scaler = MinMaxScaler(feature_range=(0, 1))
dataset = scaler.fit_transform(dataset)

#print(dataset)



#prepare the X and Y label
X,y = create_dataset(dataset)
#Take 80% of data as the training sample and 20% as testing sample
trainX, testX, trainY, testY = train_test_split(X, y, test_size=0.20, shuffle=False)
# reshape input to be [samples, time steps, features]
trainX = np.reshape(trainX, (trainX.shape[0], 1, trainX.shape[1]))
testX = np.reshape(testX, (testX.shape[0], 1, testX.shape[1]))




# create and fit the LSTM network
model = Sequential()
model.add(LSTM(4, input_shape=(1, 1)))
model.add(Dense(1))
model.compile(loss='logcosh', optimizer='adadelta')
model.fit(trainX, trainY, epochs=200, batch_size=2, verbose=2)
#save model for later use
model.save('./savedModel')
#load_model
model = load_model('./savedModel')
# make predictions
trainPredict = model.predict(trainX)
testPredict = model.predict(testX)
futurePredict = model.predict(np.asarray([[testPredict[-1]]]))
futurePredict2 = model.predict(np.asarray([futurePredict]))
futurePredict3 = model.predict(np.asarray([futurePredict2]))

futurePredict = scaler.inverse_transform(futurePredict)
futurePredict2 = scaler.inverse_transform(futurePredict2)
futurePredict3 = scaler.inverse_transform(futurePredict3)

# invert predictions
trainPredict = scaler.inverse_transform(trainPredict)
trainY = scaler.inverse_transform(trainY)
testPredict = scaler.inverse_transform(testPredict)
testY = scaler.inverse_transform(testY)
print("Jer debut")
print(scaler.inverse_transform(testX[-1]))
print(scaler.inverse_transform(testX[-2]))
print(scaler.inverse_transform(testX[-3]))
print(scaler.inverse_transform(testX[-4]))
print(scaler.inverse_transform(testX[-5]))

for i in range(1,len(testPredict)):
    if testX[-i] < testX[-i-1]: res = "A"
    else: res = "B"
    if testPredict[-i] < testPredict[-i-1]: res2 = "A"
    else: res2 = "B"
    if res == res2:
        if res == "A": print(repr(datetime_set[-i-1]) + " en BAISSE (" + repr(i) + ") " + repr(scaler.inverse_transform(testX[-i])) + "  " + repr(testPredict[-i]) )
        else: print(repr(datetime_set[-i-1]) + " en HAUSSE (" + repr(i) + ") " + repr(scaler.inverse_transform(testX[-i])) + "  " + repr(testPredict[-i]) )
    else: print(" en décalage")



print("Jer fin")

print("Price for last 5 days: ")
print(testPredict[-5:])
print("Bitcoin price for next hour: ", futurePredict)
print("                       then: ", futurePredict2)
print("                   and then: ", futurePredict3)
# calculate root mean squared error
trainScore = math.sqrt(mean_squared_error(trainY[:,0], trainPredict[:,0]))
print('Train Score: %.2f RMSE' % (trainScore))
testScore = math.sqrt(mean_squared_error(testY[:,0], testPredict[:,0]))
print('Test Score: %.2f RMSE' % (testScore))
# shift train predictions for plotting
trainPredictPlot = np.empty_like(dataset)
trainPredictPlot[:, :] = np.nan
trainPredictPlot[1:len(trainPredict)+1, :] = trainPredict
# shift test predictions for plotting
testPredictPlot = np.empty_like(dataset)
testPredictPlot[:, :] = np.nan
testPredictPlot[len(trainPredict):len(dataset)-1, :] = testPredict
# plot baseline and predictions
plt.plot(scaler.inverse_transform(dataset))
plt.plot(trainPredictPlot)
plt.plot(testPredictPlot)
#plt.show()
